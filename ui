--[[
    BSMT UI Library v4.0 - Modern Edition
    Completely Rewritten with Modern Styling
    Fixed all syntax errors and tab switching issues

    Features:
    - Modern gradient buttons with hover effects
    - Sleek labels with better typography
    - Fixed tab switching system
    - Enhanced animations and visual effects
    - Better error handling
    - Improved color scheme
]]

local Library = {}
Library.Windows = {}
Library.Flags = {}
Library.ConfigFolder = "BSMT_Configs"
Library.Notifications = {}

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Modern Color Palette
local Colors = {
    Primary = Color3.fromRGB(15, 15, 23),        -- Very dark background
    Secondary = Color3.fromRGB(25, 25, 35),      -- Panel backgrounds
    Tertiary = Color3.fromRGB(35, 35, 45),       -- Hover states
    Accent = Color3.fromRGB(88, 101, 242),       -- Discord-like purple
    AccentHover = Color3.fromRGB(98, 111, 252),  -- Lighter accent
    AccentDark = Color3.fromRGB(78, 91, 232),    -- Darker accent
    Text = Color3.fromRGB(255, 255, 255),        -- Primary text
    TextSecondary = Color3.fromRGB(180, 180, 190), -- Secondary text
    TextMuted = Color3.fromRGB(120, 120, 130),   -- Muted text
    Border = Color3.fromRGB(55, 55, 65),         -- Borders
    Success = Color3.fromRGB(67, 181, 129),      -- Success green
    Warning = Color3.fromRGB(250, 166, 26),      -- Warning orange
    Error = Color3.fromRGB(237, 66, 69),         -- Error red
    Gradient1 = Color3.fromRGB(88, 101, 242),    -- Gradient start
    Gradient2 = Color3.fromRGB(142, 68, 173)     -- Gradient end
}

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BSMT_UI_Modern"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

-- Try different parent methods
local success = false
if gethui then
    pcall(function()
        ScreenGui.Parent = gethui()
        success = true
    end)
end

if not success and syn and syn.protect_gui then
    pcall(function()
        syn.protect_gui(ScreenGui)
        ScreenGui.Parent = CoreGui
        success = true
    end)
end

if not success then
    ScreenGui.Parent = CoreGui
end

-- Enhanced Utility Functions
local function SafeTween(obj, props, duration, style, direction, callback)
    if not obj or not obj.Parent then
        return nil
    end

    local tweenInfo = TweenInfo.new(
        duration or 0.3,
        style or Enum.EasingStyle.Quart,
        direction or Enum.EasingDirection.Out
    )

    local tween = TweenService:Create(obj, tweenInfo, props)

    local success, err = pcall(function()
        tween:Play()
        if callback then
            tween.Completed:Connect(callback)
        end
    end)

    if not success then
        warn("BSMT UI: Tween failed - " .. tostring(err))
        return nil
    end

    return tween
end

local function MakeDraggable(frame, handle)
    if not frame or not handle then
        return
    end

    local dragging = false
    local dragStart = nil
    local startPos = nil

    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end

    local function onInputChanged(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end

    local function onInputEnded(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end

    handle.InputBegan:Connect(onInputBegan)
    handle.InputChanged:Connect(onInputChanged)
    handle.InputEnded:Connect(onInputEnded)
end

-- Modern Ripple Effect
local function CreateModernRipple(button)
    if not button then return end

    button.MouseButton1Click:Connect(function()
        local ripple = Instance.new("Frame")
        ripple.Name = "ModernRipple"
        ripple.Size = UDim2.new(0, 0, 0, 0)
        ripple.Position = UDim2.new(0.5, 0, 0.5, 0)
        ripple.AnchorPoint = Vector2.new(0.5, 0.5)
        ripple.BackgroundColor3 = Colors.Text
        ripple.BackgroundTransparency = 0.8
        ripple.BorderSizePixel = 0
        ripple.ZIndex = button.ZIndex + 1
        ripple.Parent = button

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(1, 0)
        corner.Parent = ripple

        SafeTween(ripple, {
            Size = UDim2.new(2, 0, 2, 0),
            BackgroundTransparency = 1
        }, 0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
            ripple:Destroy()
        end)
    end)
end

-- Notification System
local NotificationContainer = Instance.new("Frame")
NotificationContainer.Name = "NotificationContainer"
NotificationContainer.Size = UDim2.new(0, 320, 1, 0)
NotificationContainer.Position = UDim2.new(1, -340, 0, 20)
NotificationContainer.BackgroundTransparency = 1
NotificationContainer.Parent = ScreenGui

local NotificationLayout = Instance.new("UIListLayout")
NotificationLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotificationLayout.Padding = UDim.new(0, 12)
NotificationLayout.Parent = NotificationContainer

function Library:Notify(title, message, duration, type)
    local notifType = type or "info"
    local notifDuration = duration or 4

    local notification = Instance.new("Frame")
    notification.Name = "Notification"
    notification.Size = UDim2.new(1, 0, 0, 90)
    notification.BackgroundColor3 = Colors.Secondary
    notification.BorderSizePixel = 0
    notification.Parent = NotificationContainer

    local notifCorner = Instance.new("UICorner")
    notifCorner.CornerRadius = UDim.new(0, 12)
    notifCorner.Parent = notification

    -- Modern gradient accent bar
    local accentBar = Instance.new("Frame")
    accentBar.Size = UDim2.new(0, 4, 1, 0)
    accentBar.Position = UDim2.new(0, 0, 0, 0)
    accentBar.BorderSizePixel = 0
    accentBar.Parent = notification

    local barCorner = Instance.new("UICorner")
    barCorner.CornerRadius = UDim.new(0, 12)
    barCorner.Parent = accentBar

    local gradient = Instance.new("UIGradient")
    gradient.Rotation = 90
    if notifType == "success" then
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Success),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(87, 201, 149))
        }
    elseif notifType == "warning" then
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Warning),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 186, 46))
        }
    elseif notifType == "error" then
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Error),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 86, 89))
        }
    else
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Gradient1),
            ColorSequenceKeypoint.new(1, Colors.Gradient2)
        }
    end
    gradient.Parent = accentBar

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -60, 0, 30)
    titleLabel.Position = UDim2.new(0, 20, 0, 15)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title or "Notification"
    titleLabel.TextColor3 = Colors.Text
    titleLabel.TextSize = 16
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = notification

    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -60, 0, 35)
    messageLabel.Position = UDim2.new(0, 20, 0, 45)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message or ""
    messageLabel.TextColor3 = Colors.TextSecondary
    messageLabel.TextSize = 13
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.TextWrapped = true
    messageLabel.Parent = notification

    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 24, 0, 24)
    closeButton.Position = UDim2.new(1, -35, 0, 15)
    closeButton.BackgroundColor3 = Colors.Tertiary
    closeButton.Text = "×"
    closeButton.TextColor3 = Colors.TextSecondary
    closeButton.TextSize = 18
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Parent = notification

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton

    closeButton.MouseEnter:Connect(function()
        SafeTween(closeButton, {BackgroundColor3 = Colors.Error}, 0.2)
    end)

    closeButton.MouseLeave:Connect(function()
        SafeTween(closeButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
    end)

    closeButton.MouseButton1Click:Connect(function()
        SafeTween(notification, {
            Position = UDim2.new(1, 0, notification.Position.Y.Scale, notification.Position.Y.Offset),
            BackgroundTransparency = 1
        }, 0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
            notification:Destroy()
        end)
    end)

    -- Slide in animation
    notification.Position = UDim2.new(1, 0, 0, 0)
    SafeTween(notification, {Position = UDim2.new(0, 0, 0, 0)}, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

    -- Auto remove
    spawn(function()
        wait(notifDuration - 0.5)
        if notification.Parent then
            SafeTween(notification, {
                Position = UDim2.new(1, 0, notification.Position.Y.Scale, notification.Position.Y.Offset),
                BackgroundTransparency = 1
            }, 0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                notification:Destroy()
            end)
        end
    end)
end

-- Window Creation
function Library:CreateWindow(title)
    local Window = {
        Title = title,
        Tabs = {},
        CurrentTab = nil,
        Visible = true
    }

    -- Main Window Frame
    Window.Frame = Instance.new("Frame")
    Window.Frame.Name = "BSMTWindow"
    Window.Frame.Size = UDim2.new(0, 600, 0, 450)
    Window.Frame.Position = UDim2.new(0.5, -300, 0.5, -225)
    Window.Frame.BackgroundColor3 = Colors.Primary
    Window.Frame.BorderSizePixel = 0
    Window.Frame.Parent = ScreenGui

    local windowCorner = Instance.new("UICorner")
    windowCorner.CornerRadius = UDim.new(0, 16)
    windowCorner.Parent = Window.Frame

    -- Modern shadow effect
    local shadow = Instance.new("Frame")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 20, 1, 20)
    shadow.Position = UDim2.new(0, -10, 0, -10)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.7
    shadow.BorderSizePixel = 0
    shadow.ZIndex = Window.Frame.ZIndex - 1
    shadow.Parent = Window.Frame

    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 20)
    shadowCorner.Parent = shadow

    -- Header
    Window.Header = Instance.new("Frame")
    Window.Header.Name = "Header"
    Window.Header.Size = UDim2.new(1, 0, 0, 50)
    Window.Header.Position = UDim2.new(0, 0, 0, 0)
    Window.Header.BackgroundColor3 = Colors.Secondary
    Window.Header.BorderSizePixel = 0
    Window.Header.Parent = Window.Frame

    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 16)
    headerCorner.Parent = Window.Header

    -- Fix header corners (only top)
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 16)
    headerFix.Position = UDim2.new(0, 0, 1, -16)
    headerFix.BackgroundColor3 = Colors.Secondary
    headerFix.BorderSizePixel = 0
    headerFix.Parent = Window.Header

    -- Title Label
    Window.TitleLabel = Instance.new("TextLabel")
    Window.TitleLabel.Size = UDim2.new(1, -100, 1, 0)
    Window.TitleLabel.Position = UDim2.new(0, 20, 0, 0)
    Window.TitleLabel.BackgroundTransparency = 1
    Window.TitleLabel.Text = title
    Window.TitleLabel.TextColor3 = Colors.Text
    Window.TitleLabel.TextSize = 18
    Window.TitleLabel.Font = Enum.Font.GothamBold
    Window.TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    Window.TitleLabel.Parent = Window.Header

    -- Close Button
    Window.CloseButton = Instance.new("TextButton")
    Window.CloseButton.Size = UDim2.new(0, 30, 0, 30)
    Window.CloseButton.Position = UDim2.new(1, -40, 0, 10)
    Window.CloseButton.BackgroundColor3 = Colors.Tertiary
    Window.CloseButton.Text = "×"
    Window.CloseButton.TextColor3 = Colors.TextSecondary
    Window.CloseButton.TextSize = 16
    Window.CloseButton.Font = Enum.Font.GothamBold
    Window.CloseButton.Parent = Window.Header

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = Window.CloseButton

    Window.CloseButton.MouseEnter:Connect(function()
        SafeTween(Window.CloseButton, {BackgroundColor3 = Colors.Error}, 0.2)
    end)

    Window.CloseButton.MouseLeave:Connect(function()
        SafeTween(Window.CloseButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
    end)

    Window.CloseButton.MouseButton1Click:Connect(function()
        Window:Toggle()
    end)

    -- Tab Container
    Window.TabContainer = Instance.new("Frame")
    Window.TabContainer.Name = "TabContainer"
    Window.TabContainer.Size = UDim2.new(0, 150, 1, -50)
    Window.TabContainer.Position = UDim2.new(0, 0, 0, 50)
    Window.TabContainer.BackgroundColor3 = Colors.Secondary
    Window.TabContainer.BorderSizePixel = 0
    Window.TabContainer.Parent = Window.Frame

    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 2)
    tabLayout.Parent = Window.TabContainer

    local tabPadding = Instance.new("UIPadding")
    tabPadding.PaddingTop = UDim.new(0, 10)
    tabPadding.PaddingLeft = UDim.new(0, 10)
    tabPadding.PaddingRight = UDim.new(0, 10)
    tabPadding.Parent = Window.TabContainer

    -- Content Container
    Window.ContentContainer = Instance.new("Frame")
    Window.ContentContainer.Name = "ContentContainer"
    Window.ContentContainer.Size = UDim2.new(1, -150, 1, -50)
    Window.ContentContainer.Position = UDim2.new(0, 150, 0, 50)
    Window.ContentContainer.BackgroundColor3 = Colors.Primary
    Window.ContentContainer.BorderSizePixel = 0
    Window.ContentContainer.Parent = Window.Frame

    -- Make draggable
    MakeDraggable(Window.Frame, Window.Header)

    -- Toggle function
    function Window:Toggle()
        self.Visible = not self.Visible
        self.Frame.Visible = self.Visible
    end

    -- Fixed Tab Creation
    function Window:Tab(name)
        local Tab = {
            Name = name,
            Window = self,
            Elements = {}
        }

        -- Create Tab Button
        Tab.Button = Instance.new("TextButton")
        Tab.Button.Name = name .. "TabButton"
        Tab.Button.Size = UDim2.new(1, 0, 0, 45)
        Tab.Button.BackgroundColor3 = Colors.Tertiary
        Tab.Button.BorderSizePixel = 0
        Tab.Button.Text = name
        Tab.Button.TextColor3 = Colors.TextSecondary
        Tab.Button.TextSize = 14
        Tab.Button.Font = Enum.Font.GothamSemibold
        Tab.Button.Parent = self.TabContainer

        local tabCorner = Instance.new("UICorner")
        tabCorner.CornerRadius = UDim.new(0, 10)
        tabCorner.Parent = Tab.Button

        -- Create Content Frame
        Tab.Content = Instance.new("ScrollingFrame")
        Tab.Content.Name = name .. "Content"
        Tab.Content.Size = UDim2.new(1, 0, 1, 0)
        Tab.Content.Position = UDim2.new(0, 0, 0, 0)
        Tab.Content.BackgroundTransparency = 1
        Tab.Content.BorderSizePixel = 0
        Tab.Content.ScrollBarThickness = 6
        Tab.Content.ScrollBarImageColor3 = Colors.Accent
        Tab.Content.CanvasSize = UDim2.new(0, 0, 0, 0)
        Tab.Content.Visible = false
        Tab.Content.Parent = self.ContentContainer

        local contentLayout = Instance.new("UIListLayout")
        contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        contentLayout.Padding = UDim.new(0, 8)
        contentLayout.Parent = Tab.Content

        local contentPadding = Instance.new("UIPadding")
        contentPadding.PaddingTop = UDim.new(0, 15)
        contentPadding.PaddingLeft = UDim.new(0, 15)
        contentPadding.PaddingRight = UDim.new(0, 15)
        contentPadding.PaddingBottom = UDim.new(0, 15)
        contentPadding.Parent = Tab.Content

        -- Auto-resize canvas
        contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Tab.Content.CanvasSize = UDim2.new(0, 0, 0, contentLayout.AbsoluteContentSize.Y + 30)
        end)

        -- Tab button click
        Tab.Button.MouseButton1Click:Connect(function()
            self:SelectTab(Tab)
        end)

        -- Tab hover effects
        Tab.Button.MouseEnter:Connect(function()
            if self.CurrentTab ~= Tab then
                SafeTween(Tab.Button, {BackgroundColor3 = Colors.Border}, 0.2)
            end
        end)

        Tab.Button.MouseLeave:Connect(function()
            if self.CurrentTab ~= Tab then
                SafeTween(Tab.Button, {BackgroundColor3 = Colors.Tertiary}, 0.2)
            end
        end)

        -- Modern Label Function
        function Tab:Label(text)
            local label = Instance.new("TextLabel")
            label.Name = "ModernLabel"
            label.Size = UDim2.new(1, 0, 0, 40)
            label.BackgroundTransparency = 1
            label.Text = text or "Label"
            label.TextColor3 = Colors.Text
            label.TextSize = 16
            label.Font = Enum.Font.GothamMedium
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.TextYAlignment = Enum.TextYAlignment.Center
            label.Parent = self.Content

            -- Modern text effect
            local textStroke = Instance.new("UIStroke")
            textStroke.Thickness = 0.3
            textStroke.Transparency = 0.9
            textStroke.Color = Colors.Accent
            textStroke.Parent = label

            -- Fade in animation
            label.TextTransparency = 1
            SafeTween(label, {TextTransparency = 0}, 0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)

            return label
        end

        -- Modern Button Function
        function Tab:Button(text, callback)
            local buttonFrame = Instance.new("Frame")
            buttonFrame.Name = "ModernButtonFrame"
            buttonFrame.Size = UDim2.new(1, 0, 0, 50)
            buttonFrame.BackgroundTransparency = 1
            buttonFrame.Parent = self.Content

            local button = Instance.new("TextButton")
            button.Name = "ModernButton"
            button.Size = UDim2.new(1, 0, 1, 0)
            button.Position = UDim2.new(0, 0, 0, 0)
            button.BackgroundColor3 = Colors.Accent
            button.BorderSizePixel = 0
            button.Text = text or "Button"
            button.TextColor3 = Colors.Text
            button.TextSize = 15
            button.Font = Enum.Font.GothamBold
            button.Parent = buttonFrame

            -- Modern rounded corners
            local buttonCorner = Instance.new("UICorner")
            buttonCorner.CornerRadius = UDim.new(0, 12)
            buttonCorner.Parent = button

            -- Modern gradient effect
            local gradient = Instance.new("UIGradient")
            gradient.Rotation = 45
            gradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0, Colors.Gradient1),
                ColorSequenceKeypoint.new(1, Colors.Gradient2)
            }
            gradient.Parent = button

            -- Modern shadow
            local shadow = Instance.new("Frame")
            shadow.Name = "ButtonShadow"
            shadow.Size = UDim2.new(1, 0, 1, 0)
            shadow.Position = UDim2.new(0, 0, 0, 4)
            shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
            shadow.BackgroundTransparency = 0.8
            shadow.BorderSizePixel = 0
            shadow.ZIndex = button.ZIndex - 1
            shadow.Parent = buttonFrame

            local shadowCorner = Instance.new("UICorner")
            shadowCorner.CornerRadius = UDim.new(0, 12)
            shadowCorner.Parent = shadow

            -- Modern hover effects
            button.MouseEnter:Connect(function()
                SafeTween(button, {Size = UDim2.new(1, 0, 1, 2)}, 0.2)
                SafeTween(shadow, {BackgroundTransparency = 0.6}, 0.2)
                SafeTween(gradient, {Rotation = 90}, 0.3)
            end)

            button.MouseLeave:Connect(function()
                SafeTween(button, {Size = UDim2.new(1, 0, 1, 0)}, 0.2)
                SafeTween(shadow, {BackgroundTransparency = 0.8}, 0.2)
                SafeTween(gradient, {Rotation = 45}, 0.3)
            end)

            -- Click effects
            button.MouseButton1Down:Connect(function()
                SafeTween(button, {Size = UDim2.new(0.98, 0, 0.95, 0)}, 0.1)
            end)

            button.MouseButton1Up:Connect(function()
                SafeTween(button, {Size = UDim2.new(1, 0, 1, 0)}, 0.1)
            end)

            -- Add ripple effect
            CreateModernRipple(button)

            if callback then
                button.MouseButton1Click:Connect(function()
                    -- Success feedback
                    SafeTween(button, {BackgroundTransparency = 0.3}, 0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, function()
                        SafeTween(button, {BackgroundTransparency = 0}, 0.1)
                    end)
                    callback()
                end)
            end

            return button
        end

        -- Add other UI elements (Toggle, Slider, etc.) here...
        function Tab:Toggle(text, default, callback)
            local toggleFrame = Instance.new("Frame")
            toggleFrame.Name = "ModernToggle"
            toggleFrame.Size = UDim2.new(1, 0, 0, 50)
            toggleFrame.BackgroundColor3 = Colors.Secondary
            toggleFrame.BorderSizePixel = 0
            toggleFrame.Parent = self.Content

            local toggleCorner = Instance.new("UICorner")
            toggleCorner.CornerRadius = UDim.new(0, 12)
            toggleCorner.Parent = toggleFrame

            local toggleLabel = Instance.new("TextLabel")
            toggleLabel.Size = UDim2.new(1, -60, 1, 0)
            toggleLabel.Position = UDim2.new(0, 15, 0, 0)
            toggleLabel.BackgroundTransparency = 1
            toggleLabel.Text = text or "Toggle"
            toggleLabel.TextColor3 = Colors.Text
            toggleLabel.TextSize = 14
            toggleLabel.Font = Enum.Font.GothamMedium
            toggleLabel.TextXAlignment = Enum.TextXAlignment.Left
            toggleLabel.Parent = toggleFrame

            local toggleButton = Instance.new("TextButton")
            toggleButton.Size = UDim2.new(0, 40, 0, 20)
            toggleButton.Position = UDim2.new(1, -50, 0.5, -10)
            toggleButton.BackgroundColor3 = default and Colors.Accent or Colors.Tertiary
            toggleButton.BorderSizePixel = 0
            toggleButton.Text = ""
            toggleButton.Parent = toggleFrame

            local toggleButtonCorner = Instance.new("UICorner")
            toggleButtonCorner.CornerRadius = UDim.new(1, 0)
            toggleButtonCorner.Parent = toggleButton

            local toggleIndicator = Instance.new("Frame")
            toggleIndicator.Size = UDim2.new(0, 16, 0, 16)
            toggleIndicator.Position = default and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
            toggleIndicator.BackgroundColor3 = Colors.Text
            toggleIndicator.BorderSizePixel = 0
            toggleIndicator.Parent = toggleButton

            local indicatorCorner = Instance.new("UICorner")
            indicatorCorner.CornerRadius = UDim.new(1, 0)
            indicatorCorner.Parent = toggleIndicator

            local toggled = default or false

            toggleButton.MouseButton1Click:Connect(function()
                toggled = not toggled

                if toggled then
                    SafeTween(toggleButton, {BackgroundColor3 = Colors.Accent}, 0.2)
                    SafeTween(toggleIndicator, {Position = UDim2.new(1, -18, 0.5, -8)}, 0.2)
                else
                    SafeTween(toggleButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                    SafeTween(toggleIndicator, {Position = UDim2.new(0, 2, 0.5, -8)}, 0.2)
                end

                if callback then
                    callback(toggled)
                end
            end)

            return toggleFrame
        end

        function Tab:Slider(text, min, max, default, callback)
            local sliderFrame = Instance.new("Frame")
            sliderFrame.Name = "ModernSlider"
            sliderFrame.Size = UDim2.new(1, 0, 0, 70)
            sliderFrame.BackgroundColor3 = Colors.Secondary
            sliderFrame.BorderSizePixel = 0
            sliderFrame.Parent = self.Content

            local sliderCorner = Instance.new("UICorner")
            sliderCorner.CornerRadius = UDim.new(0, 12)
            sliderCorner.Parent = sliderFrame

            local sliderLabel = Instance.new("TextLabel")
            sliderLabel.Size = UDim2.new(1, -80, 0, 25)
            sliderLabel.Position = UDim2.new(0, 15, 0, 10)
            sliderLabel.BackgroundTransparency = 1
            sliderLabel.Text = text or "Slider"
            sliderLabel.TextColor3 = Colors.Text
            sliderLabel.TextSize = 14
            sliderLabel.Font = Enum.Font.GothamMedium
            sliderLabel.TextXAlignment = Enum.TextXAlignment.Left
            sliderLabel.Parent = sliderFrame

            local valueLabel = Instance.new("TextLabel")
            valueLabel.Size = UDim2.new(0, 60, 0, 25)
            valueLabel.Position = UDim2.new(1, -70, 0, 10)
            valueLabel.BackgroundTransparency = 1
            valueLabel.Text = tostring(default or min)
            valueLabel.TextColor3 = Colors.Accent
            valueLabel.TextSize = 14
            valueLabel.Font = Enum.Font.GothamBold
            valueLabel.TextXAlignment = Enum.TextXAlignment.Right
            valueLabel.Parent = sliderFrame

            local sliderTrack = Instance.new("Frame")
            sliderTrack.Size = UDim2.new(1, -30, 0, 6)
            sliderTrack.Position = UDim2.new(0, 15, 0, 45)
            sliderTrack.BackgroundColor3 = Colors.Tertiary
            sliderTrack.BorderSizePixel = 0
            sliderTrack.Parent = sliderFrame

            local trackCorner = Instance.new("UICorner")
            trackCorner.CornerRadius = UDim.new(1, 0)
            trackCorner.Parent = sliderTrack

            local sliderFill = Instance.new("Frame")
            sliderFill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
            sliderFill.Position = UDim2.new(0, 0, 0, 0)
            sliderFill.BackgroundColor3 = Colors.Accent
            sliderFill.BorderSizePixel = 0
            sliderFill.Parent = sliderTrack

            local fillCorner = Instance.new("UICorner")
            fillCorner.CornerRadius = UDim.new(1, 0)
            fillCorner.Parent = sliderFill

            local sliderKnob = Instance.new("Frame")
            sliderKnob.Size = UDim2.new(0, 16, 0, 16)
            sliderKnob.Position = UDim2.new((default - min) / (max - min), -8, 0.5, -8)
            sliderKnob.BackgroundColor3 = Colors.Text
            sliderKnob.BorderSizePixel = 0
            sliderKnob.Parent = sliderTrack

            local knobCorner = Instance.new("UICorner")
            knobCorner.CornerRadius = UDim.new(1, 0)
            knobCorner.Parent = sliderKnob

            local currentValue = default or min
            local dragging = false

            local function updateSlider(value)
                currentValue = math.clamp(value, min, max)
                local percentage = (currentValue - min) / (max - min)

                SafeTween(sliderFill, {Size = UDim2.new(percentage, 0, 1, 0)}, 0.1)
                SafeTween(sliderKnob, {Position = UDim2.new(percentage, -8, 0.5, -8)}, 0.1)

                valueLabel.Text = tostring(math.floor(currentValue))

                if callback then
                    callback(currentValue)
                end
            end

            sliderTrack.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    local percentage = math.clamp((input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X, 0, 1)
                    updateSlider(min + (max - min) * percentage)
                end
            end)

            sliderTrack.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local percentage = math.clamp((input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X, 0, 1)
                    updateSlider(min + (max - min) * percentage)
                end
            end)

            sliderTrack.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)

            return sliderFrame
        end

        function Tab:Dropdown(text, options, default, callback)
            local dropdownFrame = Instance.new("Frame")
            dropdownFrame.Name = "ModernDropdown"
            dropdownFrame.Size = UDim2.new(1, 0, 0, 50)
            dropdownFrame.BackgroundColor3 = Colors.Secondary
            dropdownFrame.BorderSizePixel = 0
            dropdownFrame.Parent = self.Content

            local dropdownCorner = Instance.new("UICorner")
            dropdownCorner.CornerRadius = UDim.new(0, 12)
            dropdownCorner.Parent = dropdownFrame

            local dropdownLabel = Instance.new("TextLabel")
            dropdownLabel.Size = UDim2.new(0.5, -10, 1, 0)
            dropdownLabel.Position = UDim2.new(0, 15, 0, 0)
            dropdownLabel.BackgroundTransparency = 1
            dropdownLabel.Text = text or "Dropdown"
            dropdownLabel.TextColor3 = Colors.Text
            dropdownLabel.TextSize = 14
            dropdownLabel.Font = Enum.Font.GothamMedium
            dropdownLabel.TextXAlignment = Enum.TextXAlignment.Left
            dropdownLabel.Parent = dropdownFrame

            local dropdownButton = Instance.new("TextButton")
            dropdownButton.Size = UDim2.new(0.5, -15, 0, 35)
            dropdownButton.Position = UDim2.new(0.5, 5, 0.5, -17.5)
            dropdownButton.BackgroundColor3 = Colors.Tertiary
            dropdownButton.BorderSizePixel = 0
            dropdownButton.Text = default or (options[1] or "Select")
            dropdownButton.TextColor3 = Colors.Text
            dropdownButton.TextSize = 13
            dropdownButton.Font = Enum.Font.Gotham
            dropdownButton.Parent = dropdownFrame

            local buttonCorner = Instance.new("UICorner")
            buttonCorner.CornerRadius = UDim.new(0, 8)
            buttonCorner.Parent = dropdownButton

            local arrow = Instance.new("TextLabel")
            arrow.Size = UDim2.new(0, 20, 1, 0)
            arrow.Position = UDim2.new(1, -25, 0, 0)
            arrow.BackgroundTransparency = 1
            arrow.Text = "▼"
            arrow.TextColor3 = Colors.TextSecondary
            arrow.TextSize = 12
            arrow.Font = Enum.Font.Gotham
            arrow.Parent = dropdownButton

            local dropdownList = Instance.new("Frame")
            dropdownList.Name = "DropdownList"
            dropdownList.Size = UDim2.new(0.5, -15, 0, 0)
            dropdownList.Position = UDim2.new(0.5, 5, 1, 5)
            dropdownList.BackgroundColor3 = Colors.Tertiary
            dropdownList.BorderSizePixel = 0
            dropdownList.Visible = false
            dropdownList.ZIndex = 10
            dropdownList.Parent = dropdownFrame

            local listCorner = Instance.new("UICorner")
            listCorner.CornerRadius = UDim.new(0, 8)
            listCorner.Parent = dropdownList

            local listLayout = Instance.new("UIListLayout")
            listLayout.SortOrder = Enum.SortOrder.LayoutOrder
            listLayout.Parent = dropdownList

            local isOpen = false
            local selectedValue = default or options[1]

            for _, option in ipairs(options) do
                local optionButton = Instance.new("TextButton")
                optionButton.Size = UDim2.new(1, 0, 0, 30)
                optionButton.BackgroundColor3 = Colors.Tertiary
                optionButton.BorderSizePixel = 0
                optionButton.Text = option
                optionButton.TextColor3 = Colors.Text
                optionButton.TextSize = 12
                optionButton.Font = Enum.Font.Gotham
                optionButton.Parent = dropdownList

                optionButton.MouseEnter:Connect(function()
                    SafeTween(optionButton, {BackgroundColor3 = Colors.Border}, 0.1)
                end)

                optionButton.MouseLeave:Connect(function()
                    SafeTween(optionButton, {BackgroundColor3 = Colors.Tertiary}, 0.1)
                end)

                optionButton.MouseButton1Click:Connect(function()
                    selectedValue = option
                    dropdownButton.Text = option

                    -- Close dropdown
                    isOpen = false
                    SafeTween(dropdownList, {Size = UDim2.new(0.5, -15, 0, 0)}, 0.2, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                        dropdownList.Visible = false
                    end)
                    SafeTween(arrow, {Rotation = 0}, 0.2)

                    if callback then
                        callback(option)
                    end
                end)
            end

            dropdownButton.MouseButton1Click:Connect(function()
                isOpen = not isOpen

                if isOpen then
                    dropdownList.Visible = true
                    SafeTween(dropdownList, {Size = UDim2.new(0.5, -15, 0, #options * 30)}, 0.2, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
                    SafeTween(arrow, {Rotation = 180}, 0.2)
                else
                    SafeTween(dropdownList, {Size = UDim2.new(0.5, -15, 0, 0)}, 0.2, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                        dropdownList.Visible = false
                    end)
                    SafeTween(arrow, {Rotation = 0}, 0.2)
                end
            end)

            return dropdownFrame
        end

        function Tab:ColorPicker(text, default, callback)
            local colorFrame = Instance.new("Frame")
            colorFrame.Name = "ModernColorPicker"
            colorFrame.Size = UDim2.new(1, 0, 0, 50)
            colorFrame.BackgroundColor3 = Colors.Secondary
            colorFrame.BorderSizePixel = 0
            colorFrame.Parent = self.Content

            local colorCorner = Instance.new("UICorner")
            colorCorner.CornerRadius = UDim.new(0, 12)
            colorCorner.Parent = colorFrame

            local colorLabel = Instance.new("TextLabel")
            colorLabel.Size = UDim2.new(1, -60, 1, 0)
            colorLabel.Position = UDim2.new(0, 15, 0, 0)
            colorLabel.BackgroundTransparency = 1
            colorLabel.Text = text or "Color Picker"
            colorLabel.TextColor3 = Colors.Text
            colorLabel.TextSize = 14
            colorLabel.Font = Enum.Font.GothamMedium
            colorLabel.TextXAlignment = Enum.TextXAlignment.Left
            colorLabel.Parent = colorFrame

            local colorPreview = Instance.new("TextButton")
            colorPreview.Size = UDim2.new(0, 35, 0, 35)
            colorPreview.Position = UDim2.new(1, -45, 0.5, -17.5)
            colorPreview.BackgroundColor3 = default or Color3.fromRGB(255, 255, 255)
            colorPreview.BorderSizePixel = 0
            colorPreview.Text = ""
            colorPreview.Parent = colorFrame

            local previewCorner = Instance.new("UICorner")
            previewCorner.CornerRadius = UDim.new(0, 8)
            previewCorner.Parent = colorPreview

            local currentColor = default or Color3.fromRGB(255, 255, 255)

            colorPreview.MouseButton1Click:Connect(function()
                -- Simple color picker (you can expand this)
                local colors = {
                    Color3.fromRGB(255, 0, 0),    -- Red
                    Color3.fromRGB(0, 255, 0),    -- Green
                    Color3.fromRGB(0, 0, 255),    -- Blue
                    Color3.fromRGB(255, 255, 0),  -- Yellow
                    Color3.fromRGB(255, 0, 255),  -- Magenta
                    Color3.fromRGB(0, 255, 255),  -- Cyan
                    Color3.fromRGB(255, 255, 255), -- White
                    Color3.fromRGB(0, 0, 0)       -- Black
                }

                local currentIndex = 1
                for i, color in ipairs(colors) do
                    if color == currentColor then
                        currentIndex = i
                        break
                    end
                end

                currentIndex = currentIndex % #colors + 1
                currentColor = colors[currentIndex]

                SafeTween(colorPreview, {BackgroundColor3 = currentColor}, 0.2)

                if callback then
                    callback(currentColor)
                end
            end)

            return colorFrame
        end

        table.insert(self.Tabs, Tab)

        -- Select first tab automatically
        if #self.Tabs == 1 then
            self:SelectTab(Tab)
        end

        return Tab
    end

    -- Fixed SelectTab function
    function Window:SelectTab(tab)
        if not tab or not tab.Button or not tab.Content then
            return
        end

        -- Deselect current tab
        if self.CurrentTab and self.CurrentTab.Button and self.CurrentTab.Content then
            SafeTween(self.CurrentTab.Button, {BackgroundColor3 = Colors.Tertiary}, 0.2)
            self.CurrentTab.Button.TextColor3 = Colors.TextSecondary
            self.CurrentTab.Content.Visible = false
        end

        -- Select new tab
        self.CurrentTab = tab
        SafeTween(tab.Button, {BackgroundColor3 = Colors.Accent}, 0.2)
        tab.Button.TextColor3 = Colors.Text
        tab.Content.Visible = true
    end

    -- Toggle keybind
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.Insert then
            Window:Toggle()
        end
    end)

    table.insert(Library.Windows, Window)
    return Window
end

-- Config System
function Library:SaveConfig(name)
    local configData = {}
    for flag, value in pairs(self.Flags) do
        configData[flag] = value
    end

    local success, result = pcall(function()
        if not isfolder(self.ConfigFolder) then
            makefolder(self.ConfigFolder)
        end
        writefile(self.ConfigFolder .. "/" .. name .. ".json", HttpService:JSONEncode(configData))
    end)

    return success
end

function Library:LoadConfig(name)
    local success, result = pcall(function()
        local configData = HttpService:JSONDecode(readfile(self.ConfigFolder .. "/" .. name .. ".json"))
        for flag, value in pairs(configData) do
            self.Flags[flag] = value
        end
    end)

    return success
end

function Library:GetConfigList()
    local configs = {}
    if isfolder(self.ConfigFolder) then
        for _, file in ipairs(listfiles(self.ConfigFolder)) do
            if file:sub(-5) == ".json" then
                table.insert(configs, file:match("([^/]+)%.json$"))
            end
        end
    end
    return configs
end

return Library
