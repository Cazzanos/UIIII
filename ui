--[[
    BSMT UI Library v4.5 - Enhanced & Fixed
    Fixed dropdown issues, improved buttons, working config system
    Features:
    - Fixed dropdown blank list and selection bugs
    - Enhanced button design without weird animations
    - Fully working config system with all features
    - All original functionality restored and enhanced
]]

local Library = {}
Library.Windows = {}
Library.Flags = {}
Library.ConfigFolder = "BSMT_Configs"
Library.Notifications = {}
Library.ToggleKey = Enum.KeyCode.RightShift

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Modern Color Palette
local Colors = {
    Primary = Color3.fromRGB(15, 15, 23),
    Secondary = Color3.fromRGB(25, 25, 35),
    Tertiary = Color3.fromRGB(35, 35, 45),
    Accent = Color3.fromRGB(88, 101, 242),
    AccentHover = Color3.fromRGB(98, 111, 252),
    AccentDark = Color3.fromRGB(78, 91, 232),
    Text = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(180, 180, 190),
    TextMuted = Color3.fromRGB(120, 120, 130),
    Border = Color3.fromRGB(55, 55, 65),
    Success = Color3.fromRGB(67, 181, 129),
    Warning = Color3.fromRGB(250, 166, 26),
    Error = Color3.fromRGB(237, 66, 69),
    Gradient1 = Color3.fromRGB(88, 101, 242),
    Gradient2 = Color3.fromRGB(142, 68, 173),
    DropdownBg = Color3.fromRGB(20, 20, 30),
    DropdownHover = Color3.fromRGB(45, 45, 55),
    ButtonPrimary = Color3.fromRGB(88, 101, 242),
    ButtonSecondary = Color3.fromRGB(45, 45, 55),
    ButtonHover = Color3.fromRGB(98, 111, 252),
    ButtonActive = Color3.fromRGB(78, 91, 232)
}

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BSMT_UI_Modern"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

-- Create a separate ScreenGui for dropdowns with higher z-index
local DropdownGui = Instance.new("ScreenGui")
DropdownGui.Name = "BSMT_Dropdown_Layer"
DropdownGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
DropdownGui.ResetOnSpawn = false

-- Try different parent methods
local success = false
if gethui then
    pcall(function()
        ScreenGui.Parent = gethui()
        DropdownGui.Parent = gethui()
        success = true
    end)
end

if not success and syn and syn.protect_gui then
    pcall(function()
        syn.protect_gui(ScreenGui)
        syn.protect_gui(DropdownGui)
        ScreenGui.Parent = CoreGui
        DropdownGui.Parent = CoreGui
        success = true
    end)
end

if not success then
    ScreenGui.Parent = CoreGui
    DropdownGui.Parent = CoreGui
end

-- Ultra-Safe Utility Functions
local function SafeTween(obj, props, duration, style, direction, callback)
    if not obj then
        return nil
    end
    local objectExists = false
    pcall(function()
        objectExists = obj and obj.Parent and obj.Parent ~= nil
    end)
    if not objectExists then
        return nil
    end
    for prop, value in pairs(props) do
        local propExists = false
        pcall(function()
            local _ = obj[prop]
            propExists = true
        end)
        if not propExists then
            return nil
        end
    end
    local tweenInfo = TweenInfo.new(
        duration or 0.3,
        style or Enum.EasingStyle.Quart,
        direction or Enum.EasingDirection.Out
    )
    local tween = nil
    pcall(function()
        tween = TweenService:Create(obj, tweenInfo, props)
        tween:Play()
        if callback then
            tween.Completed:Connect(callback)
        end
    end)
    return tween
end

local function SafeSetProperty(obj, prop, value)
    if not obj then return false end
    local success = false
    pcall(function()
        if obj and obj.Parent and obj[prop] ~= nil then
            obj[prop] = value
            success = true
        end
    end)
    return success
end

local function MakeDraggable(frame, handle)
    if not frame or not handle then
        return
    end
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end
    
    local function onInputChanged(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end
    
    local function onInputEnded(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end
    
    handle.InputBegan:Connect(onInputBegan)
    handle.InputChanged:Connect(onInputChanged)
    handle.InputEnded:Connect(onInputEnded)
end

-- Modern Ripple Effect (but improved)
local function CreateModernRipple(button)
    if not button then return end
    button.MouseButton1Click:Connect(function()
        local ripple = Instance.new("Frame")
        ripple.Name = "ModernRipple"
        ripple.Size = UDim2.new(0, 0, 0, 0)
        ripple.Position = UDim2.new(0.5, 0, 0.5, 0)
        ripple.AnchorPoint = Vector2.new(0.5, 0.5)
        ripple.BackgroundColor3 = Colors.Text
        ripple.BackgroundTransparency = 0.8
        ripple.BorderSizePixel = 0
        ripple.ZIndex = button.ZIndex + 1
        ripple.Parent = button
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(1, 0)
        corner.Parent = ripple
        
        SafeTween(ripple, {
            Size = UDim2.new(2, 0, 2, 0),
            BackgroundTransparency = 1
        }, 0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
            if ripple and ripple.Parent then
                ripple:Destroy()
            end
        end)
    end)
end

-- Enhanced Notification System with Better Animations
local NotificationContainer = Instance.new("Frame")
NotificationContainer.Name = "NotificationContainer"
NotificationContainer.Size = UDim2.new(0, 320, 1, 0)
NotificationContainer.Position = UDim2.new(1, -340, 0, 20)
NotificationContainer.BackgroundTransparency = 1
NotificationContainer.Parent = ScreenGui

local NotificationLayout = Instance.new("UIListLayout")
NotificationLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotificationLayout.Padding = UDim.new(0, 12)
NotificationLayout.Parent = NotificationContainer

function Library:Notify(title, message, duration, type)
    local notifType = type or "info"
    local notifDuration = duration or 4
    
    local notification = Instance.new("Frame")
    notification.Name = "Notification"
    notification.Size = UDim2.new(1, 0, 0, 90)
    notification.BackgroundColor3 = Colors.Secondary
    notification.BorderSizePixel = 0
    notification.BackgroundTransparency = 1
    notification.Parent = NotificationContainer
    
    local notifCorner = Instance.new("UICorner")
    notifCorner.CornerRadius = UDim.new(0, 12)
    notifCorner.Parent = notification
    
    -- Enhanced shadow effect
    local shadow = Instance.new("Frame")
    shadow.Name = "NotificationShadow"
    shadow.Size = UDim2.new(1, 4, 1, 4)
    shadow.Position = UDim2.new(0, -2, 0, 2)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.9
    shadow.BorderSizePixel = 0
    shadow.ZIndex = notification.ZIndex - 1
    shadow.Parent = notification
    
    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 14)
    shadowCorner.Parent = shadow
    
    -- Modern gradient accent bar with glow effect
    local accentBar = Instance.new("Frame")
    accentBar.Size = UDim2.new(0, 4, 1, 0)
    accentBar.Position = UDim2.new(0, 0, 0, 0)
    accentBar.BorderSizePixel = 0
    accentBar.Parent = notification
    
    local barCorner = Instance.new("UICorner")
    barCorner.CornerRadius = UDim.new(0, 12)
    barCorner.Parent = accentBar
    
    -- Glow effect for accent bar
    local glow = Instance.new("Frame")
    glow.Name = "Glow"
    glow.Size = UDim2.new(0, 8, 1, 0)
    glow.Position = UDim2.new(0, -2, 0, 0)
    glow.BackgroundTransparency = 0.7
    glow.BorderSizePixel = 0
    glow.ZIndex = accentBar.ZIndex - 1
    glow.Parent = accentBar
    
    local glowCorner = Instance.new("UICorner")
    glowCorner.CornerRadius = UDim.new(0, 16)
    glowCorner.Parent = glow
    
    local gradient = Instance.new("UIGradient")
    gradient.Rotation = 90
    
    if notifType == "success" then
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Success),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(87, 201, 149))
        }
        glow.BackgroundColor3 = Colors.Success
    elseif notifType == "warning" then
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Warning),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 186, 46))
        }
        glow.BackgroundColor3 = Colors.Warning
    elseif notifType == "error" then
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Error),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 86, 89))
        }
        glow.BackgroundColor3 = Colors.Error
    else
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Colors.Gradient1),
            ColorSequenceKeypoint.new(1, Colors.Gradient2)
        }
        glow.BackgroundColor3 = Colors.Gradient1
    end
    gradient.Parent = accentBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -60, 0, 30)
    titleLabel.Position = UDim2.new(0, 20, 0, 15)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title or "Notification"
    titleLabel.TextColor3 = Colors.Text
    titleLabel.TextSize = 16
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextTransparency = 1
    titleLabel.Parent = notification
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -60, 0, 35)
    messageLabel.Position = UDim2.new(0, 20, 0, 45)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message or ""
    messageLabel.TextColor3 = Colors.TextSecondary
    messageLabel.TextSize = 13
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.TextWrapped = true
    messageLabel.TextTransparency = 1
    messageLabel.Parent = notification
    
    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 24, 0, 24)
    closeButton.Position = UDim2.new(1, -35, 0, 15)
    closeButton.BackgroundColor3 = Colors.Tertiary
    closeButton.Text = "Ã—"
    closeButton.TextColor3 = Colors.TextSecondary
    closeButton.TextSize = 18
    closeButton.Font = Enum.Font.GothamBold
    closeButton.BackgroundTransparency = 1
    closeButton.TextTransparency = 1
    closeButton.Parent = notification
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton
    
    closeButton.MouseEnter:Connect(function()
        SafeTween(closeButton, {BackgroundColor3 = Colors.Error}, 0.2)
    end)
    
    closeButton.MouseLeave:Connect(function()
        SafeTween(closeButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        -- Enhanced close animation
        SafeTween(notification, {
            Position = UDim2.new(1, 50, notification.Position.Y.Scale, notification.Position.Y.Offset),
            BackgroundTransparency = 1
        }, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In)
        SafeTween(titleLabel, {TextTransparency = 1}, 0.3)
        SafeTween(messageLabel, {TextTransparency = 1}, 0.3)
        SafeTween(closeButton, {TextTransparency = 1, BackgroundTransparency = 1}, 0.3)
        SafeTween(accentBar, {BackgroundTransparency = 1}, 0.3)
        SafeTween(shadow, {BackgroundTransparency = 1}, 0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, function()
            if notification and notification.Parent then
                notification:Destroy()
            end
        end)
    end)
    
    -- Enhanced slide-in animation sequence
    notification.Position = UDim2.new(1, 100, 0, 0)
    -- Step 1: Slide in with bounce
    SafeTween(notification, {Position = UDim2.new(0, 0, 0, 0)}, 0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    -- Step 2: Fade in background
    SafeTween(notification, {BackgroundTransparency = 0}, 0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    -- Step 3: Fade in shadow
    SafeTween(shadow, {BackgroundTransparency = 0.85}, 0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    -- Step 4: Animate accent bar (delayed)
    wait(0.1)
    SafeTween(accentBar, {BackgroundTransparency = 0}, 0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    -- Step 5: Animate glow effect
    SafeTween(glow, {BackgroundTransparency = 0.6}, 0.4, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
    -- Step 6: Fade in text elements (staggered)
    wait(0.1)
    SafeTween(titleLabel, {TextTransparency = 0}, 0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    wait(0.1)
    SafeTween(messageLabel, {TextTransparency = 0}, 0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    wait(0.1)
    SafeTween(closeButton, {BackgroundTransparency = 0, TextTransparency = 0}, 0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    
    -- Subtle pulsing glow effect
    spawn(function()
        while notification and notification.Parent do
            SafeTween(glow, {BackgroundTransparency = 0.4}, 1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
            wait(1.5)
            if notification and notification.Parent then
                SafeTween(glow, {BackgroundTransparency = 0.7}, 1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
                wait(1.5)
            end
        end
    end)
    
    -- Enhanced auto-remove with fade-out sequence
    spawn(function()
        wait(notifDuration - 1)
        if notification and notification.Parent then
            -- Reverse animation sequence
            SafeTween(closeButton, {TextTransparency = 1, BackgroundTransparency = 1}, 0.3)
            SafeTween(messageLabel, {TextTransparency = 1}, 0.3)
            SafeTween(titleLabel, {TextTransparency = 1}, 0.3)
            SafeTween(accentBar, {BackgroundTransparency = 1}, 0.4)
            SafeTween(glow, {BackgroundTransparency = 1}, 0.4)
            SafeTween(shadow, {BackgroundTransparency = 1}, 0.4)
            SafeTween(notification, {BackgroundTransparency = 1}, 0.4)
            SafeTween(notification, {
                Position = UDim2.new(1, 50, notification.Position.Y.Scale, notification.Position.Y.Offset)
            }, 0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In, function()
                if notification and notification.Parent then
                    notification:Destroy()
                end
            end)
        end
    end)
end

-- Function to set toggle key
function Library:SetToggleKey(keyCode)
    self.ToggleKey = keyCode
    Library:Notify("ðŸ”‘ Keybind Changed", "UI toggle key changed to: " .. keyCode.Name, 3, "info")
end

-- Window Creation
function Library:CreateWindow(title)
    local Window = {
        Title = title,
        Tabs = {},
        CurrentTab = nil,
        Visible = true
    }
    
    -- Main Window Frame
    Window.Frame = Instance.new("Frame")
    Window.Frame.Name = "BSMTWindow"
    Window.Frame.Size = UDim2.new(0, 600, 0, 450)
    Window.Frame.Position = UDim2.new(0.5, -300, 0.5, -225)
    Window.Frame.BackgroundColor3 = Colors.Primary
    Window.Frame.BorderSizePixel = 0
    Window.Frame.Parent = ScreenGui
    
    local windowCorner = Instance.new("UICorner")
    windowCorner.CornerRadius = UDim.new(0, 16)
    windowCorner.Parent = Window.Frame
    
    -- Modern shadow effect
    local shadow = Instance.new("Frame")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 20, 1, 20)
    shadow.Position = UDim2.new(0, -10, 0, -10)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.7
    shadow.BorderSizePixel = 0
    shadow.ZIndex = Window.Frame.ZIndex - 1
    shadow.Parent = Window.Frame
    
    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 20)
    shadowCorner.Parent = shadow
    
    -- Header
    Window.Header = Instance.new("Frame")
    Window.Header.Name = "Header"
    Window.Header.Size = UDim2.new(1, 0, 0, 50)
    Window.Header.Position = UDim2.new(0, 0, 0, 0)
    Window.Header.BackgroundColor3 = Colors.Secondary
    Window.Header.BorderSizePixel = 0
    Window.Header.Parent = Window.Frame
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 16)
    headerCorner.Parent = Window.Header
    
    -- Fix header corners (only top)
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 16)
    headerFix.Position = UDim2.new(0, 0, 1, -16)
    headerFix.BackgroundColor3 = Colors.Secondary
    headerFix.BorderSizePixel = 0
    headerFix.Parent = Window.Header
    
    -- Title Label
    Window.TitleLabel = Instance.new("TextLabel")
    Window.TitleLabel.Size = UDim2.new(1, -100, 1, 0)
    Window.TitleLabel.Position = UDim2.new(0, 20, 0, 0)
    Window.TitleLabel.BackgroundTransparency = 1
    Window.TitleLabel.Text = title
    Window.TitleLabel.TextColor3 = Colors.Text
    Window.TitleLabel.TextSize = 18
    Window.TitleLabel.Font = Enum.Font.GothamBold
    Window.TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    Window.TitleLabel.Parent = Window.Header
    
    -- Close Button
    Window.CloseButton = Instance.new("TextButton")
    Window.CloseButton.Size = UDim2.new(0, 30, 0, 30)
    Window.CloseButton.Position = UDim2.new(1, -40, 0, 10)
    Window.CloseButton.BackgroundColor3 = Colors.Tertiary
    Window.CloseButton.Text = "Ã—"
    Window.CloseButton.TextColor3 = Colors.TextSecondary
    Window.CloseButton.TextSize = 16
    Window.CloseButton.Font = Enum.Font.GothamBold
    Window.CloseButton.Parent = Window.Header
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = Window.CloseButton
    
    Window.CloseButton.MouseEnter:Connect(function()
        SafeTween(Window.CloseButton, {BackgroundColor3 = Colors.Error}, 0.2)
    end)
    
    Window.CloseButton.MouseLeave:Connect(function()
        SafeTween(Window.CloseButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
    end)
    
    Window.CloseButton.MouseButton1Click:Connect(function()
        Window:Toggle()
    end)
    
    -- Tab Container
    Window.TabContainer = Instance.new("Frame")
    Window.TabContainer.Name = "TabContainer"
    Window.TabContainer.Size = UDim2.new(0, 150, 1, -50)
    Window.TabContainer.Position = UDim2.new(0, 0, 0, 50)
    Window.TabContainer.BackgroundColor3 = Colors.Secondary
    Window.TabContainer.BorderSizePixel = 0
    Window.TabContainer.Parent = Window.Frame
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 2)
    tabLayout.Parent = Window.TabContainer
    
    local tabPadding = Instance.new("UIPadding")
    tabPadding.PaddingTop = UDim.new(0, 10)
    tabPadding.PaddingLeft = UDim.new(0, 10)
    tabPadding.PaddingRight = UDim.new(0, 10)
    tabPadding.Parent = Window.TabContainer
    
    -- Content Container
    Window.ContentContainer = Instance.new("Frame")
    Window.ContentContainer.Name = "ContentContainer"
    Window.ContentContainer.Size = UDim2.new(1, -150, 1, -50)
    Window.ContentContainer.Position = UDim2.new(0, 150, 0, 50)
    Window.ContentContainer.BackgroundColor3 = Colors.Primary
    Window.ContentContainer.BorderSizePixel = 0
    Window.ContentContainer.Parent = Window.Frame
    
    -- Make draggable
    MakeDraggable(Window.Frame, Window.Header)
    
    -- Toggle function
    function Window:Toggle()
        self.Visible = not self.Visible
        self.Frame.Visible = self.Visible
    end
    
    -- COMPLETELY FIXED Tab Creation
    function Window:Tab(name)
        local Tab = {
            Name = name,
            Window = self,
            Elements = {},
            Button = nil,
            Content = nil
        }
        
        -- Create Tab Button with validation
        Tab.Button = Instance.new("TextButton")
        Tab.Button.Name = name .. "TabButton"
        Tab.Button.Size = UDim2.new(1, 0, 0, 45)
        Tab.Button.BackgroundColor3 = Colors.Tertiary
        Tab.Button.BorderSizePixel = 0
        Tab.Button.Text = name
        Tab.Button.TextColor3 = Colors.TextSecondary
        Tab.Button.TextSize = 14
        Tab.Button.Font = Enum.Font.GothamSemibold
        Tab.Button.Parent = self.TabContainer
        
        local tabCorner = Instance.new("UICorner")
        tabCorner.CornerRadius = UDim.new(0, 10)
        tabCorner.Parent = Tab.Button
        
        -- Create Content Frame with validation
        Tab.Content = Instance.new("ScrollingFrame")
        Tab.Content.Name = name .. "Content"
        Tab.Content.Size = UDim2.new(1, 0, 1, 0)
        Tab.Content.Position = UDim2.new(0, 0, 0, 0)
        Tab.Content.BackgroundTransparency = 1
        Tab.Content.BorderSizePixel = 0
        Tab.Content.ScrollBarThickness = 6
        Tab.Content.ScrollBarImageColor3 = Colors.Accent
        Tab.Content.CanvasSize = UDim2.new(0, 0, 0, 0)
        Tab.Content.Visible = false
        Tab.Content.Parent = self.ContentContainer
        
        local contentLayout = Instance.new("UIListLayout")
        contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        contentLayout.Padding = UDim.new(0, 8)
        contentLayout.Parent = Tab.Content
        
        local contentPadding = Instance.new("UIPadding")
        contentPadding.PaddingTop = UDim.new(0, 15)
        contentPadding.PaddingLeft = UDim.new(0, 15)
        contentPadding.PaddingRight = UDim.new(0, 15)
        contentPadding.PaddingBottom = UDim.new(0, 15)
        contentPadding.Parent = Tab.Content
        
        -- Auto-resize canvas
        contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Tab.Content.CanvasSize = UDim2.new(0, 0, 0, contentLayout.AbsoluteContentSize.Y + 30)
        end)
        
        -- Tab button click
        Tab.Button.MouseButton1Click:Connect(function()
            self:SelectTab(Tab)
        end)
        
        -- Tab hover effects
        Tab.Button.MouseEnter:Connect(function()
            if self.CurrentTab ~= Tab then
                SafeTween(Tab.Button, {BackgroundColor3 = Colors.Border}, 0.2)
            end
        end)
        
        Tab.Button.MouseLeave:Connect(function()
            if self.CurrentTab ~= Tab then
                SafeTween(Tab.Button, {BackgroundColor3 = Colors.Tertiary}, 0.2)
            end
        end)
        
        -- Modern Label Function
        function Tab:Label(text)
            local label = Instance.new("TextLabel")
            label.Name = "ModernLabel"
            label.Size = UDim2.new(1, 0, 0, 40)
            label.BackgroundTransparency = 1
            label.Text = text or "Label"
            label.TextColor3 = Colors.Text
            label.TextSize = 16
            label.Font = Enum.Font.GothamMedium
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.TextYAlignment = Enum.TextYAlignment.Center
            label.Parent = self.Content
            
            -- Modern text effect
            local textStroke = Instance.new("UIStroke")
            textStroke.Thickness = 0.3
            textStroke.Transparency = 0.9
            textStroke.Color = Colors.Accent
            textStroke.Parent = label
            
            -- Fade in animation
            label.TextTransparency = 1
            SafeTween(label, {TextTransparency = 0}, 0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
            
            return label
        end
        
        -- ENHANCED Button Function (without weird animations)
        function Tab:Button(text, callback)
            local flagName = "Button_" .. text:gsub("%s+", "_")
            
            local buttonFrame = Instance.new("Frame")
            buttonFrame.Name = "ModernButtonFrame"
            buttonFrame.Size = UDim2.new(1, 0, 0, 50)
            buttonFrame.BackgroundTransparency = 1
            buttonFrame.Parent = self.Content
            
            local button = Instance.new("TextButton")
            button.Name = "ModernButton"
            button.Size = UDim2.new(1, 0, 1, 0)
            button.Position = UDim2.new(0, 0, 0, 0)
            button.BackgroundColor3 = Colors.ButtonPrimary
            button.BorderSizePixel = 0
            button.Text = text or "Button"
            button.TextColor3 = Colors.Text
            button.TextSize = 15
            button.Font = Enum.Font.GothamBold
            button.Parent = buttonFrame
            
            -- Modern rounded corners
            local buttonCorner = Instance.new("UICorner")
            buttonCorner.CornerRadius = UDim.new(0, 12)
            buttonCorner.Parent = button
            
            -- Modern gradient effect
            local gradient = Instance.new("UIGradient")
            gradient.Rotation = 45
            gradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0, Colors.Gradient1),
                ColorSequenceKeypoint.new(1, Colors.Gradient2)
            }
            gradient.Parent = button
            
            -- Modern shadow
            local shadow = Instance.new("Frame")
            shadow.Name = "ButtonShadow"
            shadow.Size = UDim2.new(1, 0, 1, 0)
            shadow.Position = UDim2.new(0, 0, 0, 4)
            shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
            shadow.BackgroundTransparency = 0.8
            shadow.BorderSizePixel = 0
            shadow.ZIndex = button.ZIndex - 1
            shadow.Parent = buttonFrame
            
            local shadowCorner = Instance.new("UICorner")
            shadowCorner.CornerRadius = UDim.new(0, 12)
            shadowCorner.Parent = shadow
            
            -- ENHANCED hover effects (no weird ripple unless wanted)
            button.MouseEnter:Connect(function()
                SafeTween(button, {Size = UDim2.new(1, 0, 1, 2)}, 0.2)
                SafeTween(shadow, {BackgroundTransparency = 0.6}, 0.2)
                SafeTween(gradient, {Rotation = 90}, 0.3)
            end)
            
            button.MouseLeave:Connect(function()
                SafeTween(button, {Size = UDim2.new(1, 0, 1, 0)}, 0.2)
                SafeTween(shadow, {BackgroundTransparency = 0.8}, 0.2)
                SafeTween(gradient, {Rotation = 45}, 0.3)
            end)
            
            -- Click effects (no weird shockwave)
            button.MouseButton1Down:Connect(function()
                SafeTween(button, {Size = UDim2.new(0.98, 0, 0.95, 0)}, 0.1)
            end)
            
            button.MouseButton1Up:Connect(function()
                SafeTween(button, {Size = UDim2.new(1, 0, 1, 0)}, 0.1)
            end)
            
            -- OPTIONAL: Add ripple effect only if desired
            -- CreateModernRipple(button)
            
            if callback then
                button.MouseButton1Click:Connect(function()
                    -- Success feedback
                    SafeTween(button, {BackgroundTransparency = 0.3}, 0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, function()
                        SafeTween(button, {BackgroundTransparency = 0}, 0.1)
                    end)
                    
                    -- Update flag
                    Library.Flags[flagName] = true
                    
                    callback()
                end)
            end
            
            return button
        end
        
        -- Modern Toggle Function
        function Tab:Toggle(text, default, callback)
            local flagName = "Toggle_" .. text:gsub("%s+", "_")
            Library.Flags[flagName] = default or false
            
            local toggleFrame = Instance.new("Frame")
            toggleFrame.Name = "ModernToggle"
            toggleFrame.Size = UDim2.new(1, 0, 0, 50)
            toggleFrame.BackgroundColor3 = Colors.Secondary
            toggleFrame.BorderSizePixel = 0
            toggleFrame.Parent = self.Content
            
            local toggleCorner = Instance.new("UICorner")
            toggleCorner.CornerRadius = UDim.new(0, 12)
            toggleCorner.Parent = toggleFrame
            
            local toggleLabel = Instance.new("TextLabel")
            toggleLabel.Size = UDim2.new(1, -60, 1, 0)
            toggleLabel.Position = UDim2.new(0, 15, 0, 0)
            toggleLabel.BackgroundTransparency = 1
            toggleLabel.Text = text or "Toggle"
            toggleLabel.TextColor3 = Colors.Text
            toggleLabel.TextSize = 14
            toggleLabel.Font = Enum.Font.GothamMedium
            toggleLabel.TextXAlignment = Enum.TextXAlignment.Left
            toggleLabel.Parent = toggleFrame
            
            local toggleButton = Instance.new("TextButton")
            toggleButton.Size = UDim2.new(0, 40, 0, 20)
            toggleButton.Position = UDim2.new(1, -50, 0.5, -10)
            toggleButton.BackgroundColor3 = Library.Flags[flagName] and Colors.Accent or Colors.Tertiary
            toggleButton.BorderSizePixel = 0
            toggleButton.Text = ""
            toggleButton.Parent = toggleFrame
            
            local toggleButtonCorner = Instance.new("UICorner")
            toggleButtonCorner.CornerRadius = UDim.new(1, 0)
            toggleButtonCorner.Parent = toggleButton
            
            local toggleIndicator = Instance.new("Frame")
            toggleIndicator.Size = UDim2.new(0, 16, 0, 16)
            toggleIndicator.Position = Library.Flags[flagName] and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
            toggleIndicator.BackgroundColor3 = Colors.Text
            toggleIndicator.BorderSizePixel = 0
            toggleIndicator.Parent = toggleButton
            
            local indicatorCorner = Instance.new("UICorner")
            indicatorCorner.CornerRadius = UDim.new(1, 0)
            indicatorCorner.Parent = toggleIndicator
            
            toggleButton.MouseButton1Click:Connect(function()
                Library.Flags[flagName] = not Library.Flags[flagName]
                if Library.Flags[flagName] then
                    SafeTween(toggleButton, {BackgroundColor3 = Colors.Accent}, 0.2)
                    SafeTween(toggleIndicator, {Position = UDim2.new(1, -18, 0.5, -8)}, 0.2)
                else
                    SafeTween(toggleButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                    SafeTween(toggleIndicator, {Position = UDim2.new(0, 2, 0.5, -8)}, 0.2)
                end
                if callback then
                    callback(Library.Flags[flagName])
                end
            end)
            
            return toggleFrame
        end
        
        -- Modern Slider Function
        function Tab:Slider(text, min, max, default, callback)
            local flagName = "Slider_" .. text:gsub("%s+", "_")
            Library.Flags[flagName] = default or min
            
            local sliderFrame = Instance.new("Frame")
            sliderFrame.Name = "ModernSlider"
            sliderFrame.Size = UDim2.new(1, 0, 0, 70)
            sliderFrame.BackgroundColor3 = Colors.Secondary
            sliderFrame.BorderSizePixel = 0
            sliderFrame.Parent = self.Content
            
            local sliderCorner = Instance.new("UICorner")
            sliderCorner.CornerRadius = UDim.new(0, 12)
            sliderCorner.Parent = sliderFrame
            
            local sliderLabel = Instance.new("TextLabel")
            sliderLabel.Size = UDim2.new(1, -80, 0, 25)
            sliderLabel.Position = UDim2.new(0, 15, 0, 10)
            sliderLabel.BackgroundTransparency = 1
            sliderLabel.Text = text or "Slider"
            sliderLabel.TextColor3 = Colors.Text
            sliderLabel.TextSize = 14
            sliderLabel.Font = Enum.Font.GothamMedium
            sliderLabel.TextXAlignment = Enum.TextXAlignment.Left
            sliderLabel.Parent = sliderFrame
            
            local valueLabel = Instance.new("TextLabel")
            valueLabel.Size = UDim2.new(0, 60, 0, 25)
            valueLabel.Position = UDim2.new(1, -70, 0, 10)
            valueLabel.BackgroundTransparency = 1
            valueLabel.Text = tostring(Library.Flags[flagName])
            valueLabel.TextColor3 = Colors.Accent
            valueLabel.TextSize = 14
            valueLabel.Font = Enum.Font.GothamBold
            valueLabel.TextXAlignment = Enum.TextXAlignment.Right
            valueLabel.Parent = sliderFrame
            
            local sliderTrack = Instance.new("Frame")
            sliderTrack.Size = UDim2.new(1, -30, 0, 6)
            sliderTrack.Position = UDim2.new(0, 15, 0, 45)
            sliderTrack.BackgroundColor3 = Colors.Tertiary
            sliderTrack.BorderSizePixel = 0
            sliderTrack.Parent = sliderFrame
            
            local trackCorner = Instance.new("UICorner")
            trackCorner.CornerRadius = UDim.new(1, 0)
            trackCorner.Parent = sliderTrack
            
            local sliderFill = Instance.new("Frame")
            sliderFill.Size = UDim2.new((Library.Flags[flagName] - min) / (max - min), 0, 1, 0)
            sliderFill.Position = UDim2.new(0, 0, 0, 0)
            sliderFill.BackgroundColor3 = Colors.Accent
            sliderFill.BorderSizePixel = 0
            sliderFill.Parent = sliderTrack
            
            local fillCorner = Instance.new("UICorner")
            fillCorner.CornerRadius = UDim.new(1, 0)
            fillCorner.Parent = sliderFill
            
            local sliderKnob = Instance.new("Frame")
            sliderKnob.Size = UDim2.new(0, 16, 0, 16)
            sliderKnob.Position = UDim2.new((Library.Flags[flagName] - min) / (max - min), -8, 0.5, -8)
            sliderKnob.BackgroundColor3 = Colors.Text
            sliderKnob.BorderSizePixel = 0
            sliderKnob.Parent = sliderTrack
            
            local knobCorner = Instance.new("UICorner")
            knobCorner.CornerRadius = UDim.new(1, 0)
            knobCorner.Parent = sliderKnob
            
            local dragging = false
            
            local function updateSlider(value)
                Library.Flags[flagName] = math.clamp(value, min, max)
                local percentage = (Library.Flags[flagName] - min) / (max - min)
                SafeTween(sliderFill, {Size = UDim2.new(percentage, 0, 1, 0)}, 0.1)
                SafeTween(sliderKnob, {Position = UDim2.new(percentage, -8, 0.5, -8)}, 0.1)
                valueLabel.Text = tostring(math.floor(Library.Flags[flagName]))
                if callback then
                    callback(Library.Flags[flagName])
                end
            end
            
            sliderTrack.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    local percentage = math.clamp((input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X, 0, 1)
                    updateSlider(min + (max - min) * percentage)
                end
            end)
            
            sliderTrack.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local percentage = math.clamp((input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X, 0, 1)
                    updateSlider(min + (max - min) * percentage)
                end
            end)
            
            sliderTrack.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            
            return sliderFrame
        end
        
        -- COMPLETELY FIXED Dropdown Function
        function Tab:Dropdown(text, options, default, callback)
            local flagName = "Dropdown_" .. text:gsub("%s+", "_")
            Library.Flags[flagName] = default or options[1] or "Select"
            
            local dropdownFrame = Instance.new("Frame")
            dropdownFrame.Name = "ModernDropdown"
            dropdownFrame.Size = UDim2.new(1, 0, 0, 50)
            dropdownFrame.BackgroundColor3 = Colors.Secondary
            dropdownFrame.BorderSizePixel = 0
            dropdownFrame.Parent = self.Content
            
            local dropdownCorner = Instance.new("UICorner")
            dropdownCorner.CornerRadius = UDim.new(0, 12)
            dropdownCorner.Parent = dropdownFrame
            
            local dropdownLabel = Instance.new("TextLabel")
            dropdownLabel.Size = UDim2.new(0.5, -10, 1, 0)
            dropdownLabel.Position = UDim2.new(0, 15, 0, 0)
            dropdownLabel.BackgroundTransparency = 1
            dropdownLabel.Text = text or "Dropdown"
            dropdownLabel.TextColor3 = Colors.Text
            dropdownLabel.TextSize = 14
            dropdownLabel.Font = Enum.Font.GothamMedium
            dropdownLabel.TextXAlignment = Enum.TextXAlignment.Left
            dropdownLabel.Parent = dropdownFrame
            
            local dropdownButton = Instance.new("TextButton")
            dropdownButton.Size = UDim2.new(0.5, -15, 0, 35)
            dropdownButton.Position = UDim2.new(0.5, 5, 0.5, -17.5)
            dropdownButton.BackgroundColor3 = Colors.Tertiary
            dropdownButton.BorderSizePixel = 0
            dropdownButton.Text = Library.Flags[flagName]
            dropdownButton.TextColor3 = Colors.Text
            dropdownButton.TextSize = 13
            dropdownButton.Font = Enum.Font.Gotham
            dropdownButton.Parent = dropdownFrame
            
            local buttonCorner = Instance.new("UICorner")
            buttonCorner.CornerRadius = UDim.new(0, 8)
            buttonCorner.Parent = dropdownButton
            
            -- Enhanced arrow with better styling
            local arrow = Instance.new("TextLabel")
            arrow.Size = UDim2.new(0, 20, 1, 0)
            arrow.Position = UDim2.new(1, -25, 0, 0)
            arrow.BackgroundTransparency = 1
            arrow.Text = "â–¼"
            arrow.TextColor3 = Colors.Accent
            arrow.TextSize = 12
            arrow.Font = Enum.Font.GothamBold
            arrow.Parent = dropdownButton
            
            -- Create dropdown list in separate GUI for proper z-index
            local dropdownList = Instance.new("Frame")
            dropdownList.Name = "DropdownList"
            dropdownList.BackgroundColor3 = Colors.DropdownBg
            dropdownList.BorderSizePixel = 0
            dropdownList.Visible = false
            dropdownList.ZIndex = 1000 -- Very high z-index
            dropdownList.Parent = DropdownGui
            
            -- Enhanced styling for dropdown list
            local listCorner = Instance.new("UICorner")
            listCorner.CornerRadius = UDim.new(0, 10)
            listCorner.Parent = dropdownList
            
            -- Add shadow to dropdown list
            local listShadow = Instance.new("Frame")
            listShadow.Name = "DropdownShadow"
            listShadow.Size = UDim2.new(1, 6, 1, 6)
            listShadow.Position = UDim2.new(0, -3, 0, 3)
            listShadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
            listShadow.BackgroundTransparency = 0.8
            listShadow.BorderSizePixel = 0
            listShadow.ZIndex = dropdownList.ZIndex - 1
            listShadow.Parent = dropdownList
            
            local shadowCorner = Instance.new("UICorner")
            shadowCorner.CornerRadius = UDim.new(0, 12)
            shadowCorner.Parent = listShadow
            
            -- Add border to dropdown list
            local listBorder = Instance.new("UIStroke")
            listBorder.Thickness = 1
            listBorder.Color = Colors.Border
            listBorder.Transparency = 0.5
            listBorder.Parent = dropdownList
            
            -- FIXED: Create ScrollingFrame instead of regular Frame to handle overflow
            local scrollingFrame = Instance.new("ScrollingFrame")
            scrollingFrame.Size = UDim2.new(1, 0, 1, 0)
            scrollingFrame.Position = UDim2.new(0, 0, 0, 0)
            scrollingFrame.BackgroundTransparency = 1
            scrollingFrame.BorderSizePixel = 0
            scrollingFrame.ScrollBarThickness = 4
            scrollingFrame.ScrollBarImageColor3 = Colors.Accent
            scrollingFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
            scrollingFrame.ZIndex = dropdownList.ZIndex + 1
            scrollingFrame.Parent = dropdownList
            
            local listLayout = Instance.new("UIListLayout")
            listLayout.SortOrder = Enum.SortOrder.LayoutOrder
            listLayout.Padding = UDim.new(0, 2)
            listLayout.Parent = scrollingFrame
            
            local listPadding = Instance.new("UIPadding")
            listPadding.PaddingTop = UDim.new(0, 5)
            listPadding.PaddingBottom = UDim.new(0, 5)
            listPadding.PaddingLeft = UDim.new(0, 5)
            listPadding.PaddingRight = UDim.new(0, 5)
            listPadding.Parent = scrollingFrame
            
            -- Auto-resize canvas
            listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                scrollingFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
            end)
            
            local isOpen = false
            
            -- Function to update dropdown position
            local function updateDropdownPosition()
                local buttonPos = dropdownButton.AbsolutePosition
                local buttonSize = dropdownButton.AbsoluteSize
                local screenSize = workspace.CurrentCamera.ViewportSize
                
                local maxListHeight = 150 -- Maximum height for dropdown
                local optionHeight = 30
                local totalOptionsHeight = #options * optionHeight + 10
                local listHeight = math.min(totalOptionsHeight, maxListHeight)
                local listWidth = buttonSize.X
                
                -- Calculate position
                local posX = buttonPos.X
                local posY = buttonPos.Y + buttonSize.Y + 5
                
                -- Check if dropdown goes off screen vertically
                if posY + listHeight > screenSize.Y then
                    posY = buttonPos.Y - listHeight - 5 -- Show above button
                end
                
                -- Check if dropdown goes off screen horizontally
                if posX + listWidth > screenSize.X then
                    posX = screenSize.X - listWidth - 10
                end
                
                dropdownList.Position = UDim2.new(0, posX, 0, posY)
                dropdownList.Size = UDim2.new(0, listWidth, 0, listHeight)
            end
            
            -- FIXED: Create option buttons - No blank options
            local optionButtons = {}
            for i, option in ipairs(options) do
                if option and tostring(option) ~= "" then -- Only create non-empty options
                    local optionButton = Instance.new("TextButton")
                    optionButton.Size = UDim2.new(1, 0, 0, 28)
                    optionButton.BackgroundColor3 = Colors.DropdownBg
                    optionButton.BorderSizePixel = 0
                    optionButton.Text = tostring(option) -- Ensure it's a string
                    optionButton.TextColor3 = Colors.Text
                    optionButton.TextSize = 12
                    optionButton.Font = Enum.Font.Gotham
                    optionButton.TextXAlignment = Enum.TextXAlignment.Left
                    optionButton.ZIndex = scrollingFrame.ZIndex + 1
                    optionButton.Parent = scrollingFrame
                    
                    local optionCorner = Instance.new("UICorner")
                    optionCorner.CornerRadius = UDim.new(0, 6)
                    optionCorner.Parent = optionButton
                    
                    local optionPadding = Instance.new("UIPadding")
                    optionPadding.PaddingLeft = UDim.new(0, 10)
                    optionPadding.Parent = optionButton
                    
                    -- Highlight current selection
                    if tostring(option) == tostring(Library.Flags[flagName]) then
                        optionButton.BackgroundColor3 = Colors.Accent
                    end
                    
                    -- Enhanced hover effects
                    optionButton.MouseEnter:Connect(function()
                        if tostring(option) ~= tostring(Library.Flags[flagName]) then
                            SafeTween(optionButton, {BackgroundColor3 = Colors.DropdownHover}, 0.15)
                            SafeTween(optionButton, {TextColor3 = Colors.Accent}, 0.15)
                        end
                    end)
                    
                    optionButton.MouseLeave:Connect(function()
                        if tostring(option) ~= tostring(Library.Flags[flagName]) then
                            SafeTween(optionButton, {BackgroundColor3 = Colors.DropdownBg}, 0.15)
                            SafeTween(optionButton, {TextColor3 = Colors.Text}, 0.15)
                        end
                    end)
                    
                    optionButton.MouseButton1Click:Connect(function()
                        -- Update flag
                        Library.Flags[flagName] = option
                        dropdownButton.Text = tostring(option)
                        
                        -- Update all option button highlights
                        for _, btn in pairs(optionButtons) do
                            if btn and btn.Parent then
                                if btn.Text == tostring(option) then
                                    SafeTween(btn, {BackgroundColor3 = Colors.Accent}, 0.15)
                                else
                                    SafeTween(btn, {BackgroundColor3 = Colors.DropdownBg}, 0.15)
                                    SafeTween(btn, {TextColor3 = Colors.Text}, 0.15)
                                end
                            end
                        end
                        
                        -- Enhanced close animation
                        isOpen = false
                        SafeTween(dropdownList, {
                            Size = UDim2.new(0, dropdownList.AbsoluteSize.X, 0, 0),
                            BackgroundTransparency = 1
                        }, 0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                            dropdownList.Visible = false
                        end)
                        SafeTween(listShadow, {BackgroundTransparency = 1}, 0.2)
                        SafeTween(arrow, {Rotation = 0, TextColor3 = Colors.Accent}, 0.2)
                        SafeTween(dropdownButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                        
                        if callback then
                            callback(option)
                        end
                    end)
                    
                    table.insert(optionButtons, optionButton)
                end
            end
            
            -- Enhanced button hover effects
            dropdownButton.MouseEnter:Connect(function()
                SafeTween(dropdownButton, {BackgroundColor3 = Colors.Border}, 0.2)
                SafeTween(arrow, {TextColor3 = Colors.AccentHover}, 0.2)
            end)
            
            dropdownButton.MouseLeave:Connect(function()
                if not isOpen then
                    SafeTween(dropdownButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                    SafeTween(arrow, {TextColor3 = Colors.Accent}, 0.2)
                end
            end)
            
            dropdownButton.MouseButton1Click:Connect(function()
                isOpen = not isOpen
                if isOpen then
                    updateDropdownPosition()
                    dropdownList.Visible = true
                    
                    -- Enhanced open animation
                    dropdownList.Size = UDim2.new(0, dropdownButton.AbsoluteSize.X, 0, 0)
                    dropdownList.BackgroundTransparency = 1
                    listShadow.BackgroundTransparency = 1
                    
                    local targetHeight = math.min(#options * 30 + 10, 150)
                    SafeTween(dropdownList, {
                        Size = UDim2.new(0, dropdownButton.AbsoluteSize.X, 0, targetHeight),
                        BackgroundTransparency = 0
                    }, 0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
                    SafeTween(listShadow, {BackgroundTransparency = 0.8}, 0.25)
                    SafeTween(arrow, {Rotation = 180, TextColor3 = Colors.AccentHover}, 0.25)
                    SafeTween(dropdownButton, {BackgroundColor3 = Colors.Accent}, 0.2)
                else
                    -- Enhanced close animation
                    SafeTween(dropdownList, {
                        Size = UDim2.new(0, dropdownList.AbsoluteSize.X, 0, 0),
                        BackgroundTransparency = 1
                    }, 0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                        dropdownList.Visible = false
                    end)
                    SafeTween(listShadow, {BackgroundTransparency = 1}, 0.2)
                    SafeTween(arrow, {Rotation = 0, TextColor3 = Colors.Accent}, 0.2)
                    SafeTween(dropdownButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                end
            end)
            
            -- Close dropdown when clicking outside
            UserInputService.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 and isOpen then
                    local mousePos = UserInputService:GetMouseLocation()
                    local listPos = dropdownList.AbsolutePosition
                    local listSize = dropdownList.AbsoluteSize
                    local buttonPos = dropdownButton.AbsolutePosition
                    local buttonSize = dropdownButton.AbsoluteSize
                    
                    -- Check if click is outside both button and list
                    local outsideButton = mousePos.X < buttonPos.X or mousePos.X > buttonPos.X + buttonSize.X or
                                         mousePos.Y < buttonPos.Y or mousePos.Y > buttonPos.Y + buttonSize.Y
                    local outsideList = mousePos.X < listPos.X or mousePos.X > listPos.X + listSize.X or
                                       mousePos.Y < listPos.Y or mousePos.Y > listPos.Y + listSize.Y
                    
                    if outsideButton and outsideList then
                        isOpen = false
                        SafeTween(dropdownList, {
                            Size = UDim2.new(0, dropdownList.AbsoluteSize.X, 0, 0),
                            BackgroundTransparency = 1
                        }, 0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                            dropdownList.Visible = false
                        end)
                        SafeTween(listShadow, {BackgroundTransparency = 1}, 0.2)
                        SafeTween(arrow, {Rotation = 0, TextColor3 = Colors.Accent}, 0.2)
                        SafeTween(dropdownButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                    end
                end
            end)
            
            -- Return dropdown object with utility functions
            local dropdownObject = {
                Frame = dropdownFrame,
                Button = dropdownButton,
                List = dropdownList,
                SetSelected = function(self, value)
                    if table.find(options, value) then
                        Library.Flags[flagName] = value
                        dropdownButton.Text = tostring(value)
                        -- Update option highlights
                        for _, btn in pairs(optionButtons) do
                            if btn and btn.Parent then
                                if btn.Text == tostring(value) then
                                    SafeTween(btn, {BackgroundColor3 = Colors.Accent}, 0.15)
                                else
                                    SafeTween(btn, {BackgroundColor3 = Colors.DropdownBg}, 0.15)
                                    SafeTween(btn, {TextColor3 = Colors.Text}, 0.15)
                                end
                            end
                        end
                        if callback then
                            callback(value)
                        end
                    end
                end,
                Refresh = function(self, newOptions, newDefault)
                    options = newOptions or options
                    Library.Flags[flagName] = newDefault or Library.Flags[flagName]
                    dropdownButton.Text = tostring(Library.Flags[flagName])
                    
                    -- Clear existing options
                    for _, child in ipairs(scrollingFrame:GetChildren()) do
                        if child:IsA("TextButton") then
                            child:Destroy()
                        end
                    end
                    
                    -- Clear option buttons table
                    optionButtons = {}
                    
                    -- Recreate options - FIXED: No blank options
                    for i, option in ipairs(options) do
                        if option and tostring(option) ~= "" then -- Only create non-empty options
                            local optionButton = Instance.new("TextButton")
                            optionButton.Size = UDim2.new(1, 0, 0, 28)
                            optionButton.BackgroundColor3 = Colors.DropdownBg
                            optionButton.BorderSizePixel = 0
                            optionButton.Text = tostring(option)
                            optionButton.TextColor3 = Colors.Text
                            optionButton.TextSize = 12
                            optionButton.Font = Enum.Font.Gotham
                            optionButton.TextXAlignment = Enum.TextXAlignment.Left
                            optionButton.ZIndex = scrollingFrame.ZIndex + 1
                            optionButton.Parent = scrollingFrame
                            
                            local optionCorner = Instance.new("UICorner")
                            optionCorner.CornerRadius = UDim.new(0, 6)
                            optionCorner.Parent = optionButton
                            
                            local optionPadding = Instance.new("UIPadding")
                            optionPadding.PaddingLeft = UDim.new(0, 10)
                            optionPadding.Parent = optionButton
                            
                            -- Highlight current selection
                            if tostring(option) == tostring(Library.Flags[flagName]) then
                                optionButton.BackgroundColor3 = Colors.Accent
                            end
                            
                            optionButton.MouseEnter:Connect(function()
                                if tostring(option) ~= tostring(Library.Flags[flagName]) then
                                    SafeTween(optionButton, {BackgroundColor3 = Colors.DropdownHover}, 0.15)
                                    SafeTween(optionButton, {TextColor3 = Colors.Accent}, 0.15)
                                end
                            end)
                            
                            optionButton.MouseLeave:Connect(function()
                                if tostring(option) ~= tostring(Library.Flags[flagName]) then
                                    SafeTween(optionButton, {BackgroundColor3 = Colors.DropdownBg}, 0.15)
                                    SafeTween(optionButton, {TextColor3 = Colors.Text}, 0.15)
                                end
                            end)
                            
                            optionButton.MouseButton1Click:Connect(function()
                                Library.Flags[flagName] = option
                                dropdownButton.Text = tostring(option)
                                
                                -- Update all option button highlights
                                for _, btn in pairs(optionButtons) do
                                    if btn and btn.Parent then
                                        if btn.Text == tostring(option) then
                                            SafeTween(btn, {BackgroundColor3 = Colors.Accent}, 0.15)
                                        else
                                            SafeTween(btn, {BackgroundColor3 = Colors.DropdownBg}, 0.15)
                                            SafeTween(btn, {TextColor3 = Colors.Text}, 0.15)
                                        end
                                    end
                                end
                                
                                isOpen = false
                                SafeTween(dropdownList, {
                                    Size = UDim2.new(0, dropdownList.AbsoluteSize.X, 0, 0),
                                    BackgroundTransparency = 1
                                }, 0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out, function()
                                    dropdownList.Visible = false
                                end)
                                SafeTween(listShadow, {BackgroundTransparency = 1}, 0.2)
                                SafeTween(arrow, {Rotation = 0, TextColor3 = Colors.Accent}, 0.2)
                                SafeTween(dropdownButton, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                                
                                if callback then
                                    callback(option)
                                end
                            end)
                            
                            table.insert(optionButtons, optionButton)
                        end
                    end
                end
            }
            
            return dropdownObject
        end
        
        -- Modern ColorPicker Function
        function Tab:ColorPicker(text, default, callback)
            local flagName = "ColorPicker_" .. text:gsub("%s+", "_")
            Library.Flags[flagName] = default or Color3.fromRGB(255, 255, 255)
            
            local colorFrame = Instance.new("Frame")
            colorFrame.Name = "ModernColorPicker"
            colorFrame.Size = UDim2.new(1, 0, 0, 50)
            colorFrame.BackgroundColor3 = Colors.Secondary
            colorFrame.BorderSizePixel = 0
            colorFrame.Parent = self.Content
            
            local colorCorner = Instance.new("UICorner")
            colorCorner.CornerRadius = UDim.new(0, 12)
            colorCorner.Parent = colorFrame
            
            local colorLabel = Instance.new("TextLabel")
            colorLabel.Size = UDim2.new(1, -60, 1, 0)
            colorLabel.Position = UDim2.new(0, 15, 0, 0)
            colorLabel.BackgroundTransparency = 1
            colorLabel.Text = text or "Color Picker"
            colorLabel.TextColor3 = Colors.Text
            colorLabel.TextSize = 14
            colorLabel.Font = Enum.Font.GothamMedium
            colorLabel.TextXAlignment = Enum.TextXAlignment.Left
            colorLabel.Parent = colorFrame
            
            local colorPreview = Instance.new("TextButton")
            colorPreview.Size = UDim2.new(0, 35, 0, 35)
            colorPreview.Position = UDim2.new(1, -45, 0.5, -17.5)
            colorPreview.BackgroundColor3 = Library.Flags[flagName]
            colorPreview.BorderSizePixel = 0
            colorPreview.Text = ""
            colorPreview.Parent = colorFrame
            
            local previewCorner = Instance.new("UICorner")
            previewCorner.CornerRadius = UDim.new(0, 8)
            previewCorner.Parent = colorPreview
            
            colorPreview.MouseButton1Click:Connect(function()
                -- Simple color picker (you can expand this)
                local colors = {
                    Color3.fromRGB(255, 0, 0),    -- Red
                    Color3.fromRGB(0, 255, 0),    -- Green
                    Color3.fromRGB(0, 0, 255),    -- Blue
                    Color3.fromRGB(255, 255, 0),  -- Yellow
                    Color3.fromRGB(255, 0, 255),  -- Magenta
                    Color3.fromRGB(0, 255, 255),  -- Cyan
                    Color3.fromRGB(255, 255, 255), -- White
                    Color3.fromRGB(0, 0, 0)       -- Black
                }
                
                local currentIndex = 1
                for i, color in ipairs(colors) do
                    if color == Library.Flags[flagName] then
                        currentIndex = i
                        break
                    end
                end
                
                currentIndex = currentIndex % #colors + 1
                Library.Flags[flagName] = colors[currentIndex]
                SafeTween(colorPreview, {BackgroundColor3 = Library.Flags[flagName]}, 0.2)
                
                if callback then
                    callback(Library.Flags[flagName])
                end
            end)
            
            return colorFrame
        end
        
        table.insert(self.Tabs, Tab)
        
        -- Select first tab automatically
        if #self.Tabs == 1 then
            self:SelectTab(Tab)
        end
        
        return Tab
    end
    
    -- COMPLETELY FIXED SelectTab function with ultra-safe property access
    function Window:SelectTab(tab)
        -- Validate tab object completely
        if not tab then
            return
        end
        
        -- Validate tab has required properties
        if not tab.Button or not tab.Content then
            return
        end
        
        -- Ultra-safe deselection of current tab
        if self.CurrentTab then
            -- Check if current tab button exists and is valid
            if self.CurrentTab.Button then
                local buttonValid = false
                pcall(function()
                    buttonValid = self.CurrentTab.Button and self.CurrentTab.Button.Parent
                end)
                if buttonValid then
                    SafeTween(self.CurrentTab.Button, {BackgroundColor3 = Colors.Tertiary}, 0.2)
                    SafeSetProperty(self.CurrentTab.Button, "TextColor3", Colors.TextSecondary)
                end
            end
            
            -- Check if current tab content exists and is valid
            if self.CurrentTab.Content then
                local contentValid = false
                pcall(function()
                    contentValid = self.CurrentTab.Content and self.CurrentTab.Content.Parent
                end)
                if contentValid then
                    SafeSetProperty(self.CurrentTab.Content, "Visible", false)
                end
            end
        end
        
        -- Ultra-safe selection of new tab
        self.CurrentTab = tab
        
        -- Check if new tab button exists and is valid
        if tab.Button then
            local buttonValid = false
            pcall(function()
                buttonValid = tab.Button and tab.Button.Parent
            end)
            if buttonValid then
                SafeTween(tab.Button, {BackgroundColor3 = Colors.Accent}, 0.2)
                SafeSetProperty(tab.Button, "TextColor3", Colors.Text)
            end
        end
        
        -- Check if new tab content exists and is valid
        if tab.Content then
            local contentValid = false
            pcall(function()
                contentValid = tab.Content and tab.Content.Parent
            end)
            if contentValid then
                SafeSetProperty(tab.Content, "Visible", true)
            end
        end
    end
    
    -- Fixed Toggle keybind with customizable key
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Library.ToggleKey then
            Window:Toggle()
        end
    end)
    
    table.insert(Library.Windows, Window)
    
    -- Show enhanced welcome notification
    spawn(function()
        wait(0.5) -- Small delay to ensure UI is fully loaded
        Library:Notify("ðŸŽ‰ BSMT UI Enhanced", "UI Library loaded successfully! Press " .. Library.ToggleKey.Name .. " to toggle the interface.", 5, "success")
    end)
    
    return Window
end

-- Enhanced Config System with Full Functionality
function Library:SaveConfig(name)
    if not name or name == "" then
        Library:Notify("âŒ Save Failed", "Please provide a valid config name", 3, "error")
        return false
    end
    
    local configData = {}
    for flag, value in pairs(self.Flags) do
        configData[flag] = value
    end
    
    local success, result = pcall(function()
        if not isfolder(self.ConfigFolder) then
            makefolder(self.ConfigFolder)
        end
        writefile(self.ConfigFolder .. "/" .. name .. ".json", HttpService:JSONEncode(configData))
    end)
    
    if success then
        Library:Notify("ðŸ’¾ Config Saved", "Configuration '" .. name .. "' saved successfully with " .. tostring(table.getn(configData)) .. " settings!", 4, "success")
    else
        Library:Notify("âŒ Save Failed", "Failed to save configuration '" .. name .. "': " .. tostring(result), 4, "error")
    end
    
    return success
end

function Library:LoadConfig(name)
    if not name or name == "" then
        Library:Notify("âŒ Load Failed", "Please provide a valid config name", 3, "error")
        return false
    end
    
    local success, result = pcall(function()
        if not isfile(self.ConfigFolder .. "/" .. name .. ".json") then
            error("Config file does not exist")
        end
        
        local configData = HttpService:JSONDecode(readfile(self.ConfigFolder .. "/" .. name .. ".json"))
        local loadedCount = 0
        
        for flag, value in pairs(configData) do
            self.Flags[flag] = value
            loadedCount = loadedCount + 1
        end
        
        return loadedCount
    end)
    
    if success then
        Library:Notify("ðŸ“ Config Loaded", "Configuration '" .. name .. "' loaded successfully with " .. tostring(result) .. " settings!", 4, "success")
        
        -- Refresh all UI elements to reflect loaded values
        for _, window in ipairs(self.Windows) do
            for _, tab in ipairs(window.Tabs) do
                -- You can add code here to refresh UI elements if needed
            end
        end
    else
        Library:Notify("âŒ Load Failed", "Failed to load configuration '" .. name .. "': " .. tostring(result), 4, "error")
    end
    
    return success
end

function Library:DeleteConfig(name)
    if not name or name == "" then
        Library:Notify("âŒ Delete Failed", "Please provide a valid config name", 3, "error")
        return false
    end
    
    local success, result = pcall(function()
        if not isfile(self.ConfigFolder .. "/" .. name .. ".json") then
            error("Config file does not exist")
        end
        
        delfile(self.ConfigFolder .. "/" .. name .. ".json")
    end)
    
    if success then
        Library:Notify("ðŸ—‘ï¸ Config Deleted", "Configuration '" .. name .. "' deleted successfully!", 3, "warning")
    else
        Library:Notify("âŒ Delete Failed", "Failed to delete configuration '" .. name .. "': " .. tostring(result), 3, "error")
    end
    
    return success
end

function Library:GetConfigList()
    local configs = {}
    local success, result = pcall(function()
        if isfolder(self.ConfigFolder) then
            for _, file in ipairs(listfiles(self.ConfigFolder)) do
                if file:sub(-5) == ".json" then
                    local configName = file:match("([^/\\]+)%.json$")
                    if configName then
                        table.insert(configs, configName)
                    end
                end
            end
        end
    end)
    
    if not success then
        Library:Notify("âŒ Config List Error", "Failed to get config list: " .. tostring(result), 3, "error")
    end
    
    return configs
end

-- Function to get current flag values (useful for debugging)
function Library:GetFlags()
    return self.Flags
end

-- Function to set flag value programmatically
function Library:SetFlag(flagName, value)
    self.Flags[flagName] = value
end

return Library
